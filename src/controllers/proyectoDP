// src/controllers/proyectoController.js
/**
 * Controlador para manejar las operaciones CRUD de proyectos.
 * @class
 */
import ProyectoService from '../services/proyectoService.js';
import { proyectoCreateSchema, proyectoUpdateSchema } from '../middlewares/validation/proyectoSchema.js';
import ApiError from '../utils/ApiError.js';

class ProyectoController {
  /**
   * Crea una instancia del controlador.
   * Inicializa el servicio de proyectos.
   */
  constructor() {
    /**
     * Instancia del servicio de proyectos.
     * @type {ProyectoService}
     */
    this.proyectoService = new ProyectoService();
  }

  /**
   * Maneja la creación de un nuevo proyecto.
   * @async
   * @param {Object} req - Objeto de solicitud Express.
   * @param {Object} res - Objeto de respuesta Express.
   * @param {Function} next - Función para pasar al siguiente middleware.
   */
  async crearProyecto(req, res, next) {
    try {
      // Validar los datos de entrada con Zod
      const validatedData = proyectoCreateSchema.parse(req.body);
      
      // Crear el proyecto usando el servicio
      const proyecto = await this.proyectoService.crearProyecto(validatedData);
      
      // Responder con el proyecto creado
      res.status(201).json(proyecto);
    } catch (error) {
      // Pasar el error al middleware de manejo de errores
      next(new ApiError(error.message, 400));
    }
  }

  /**
   * Maneja la obtención de un proyecto por su ID.
   * @async
   * @param {Object} req - Objeto de solicitud Express.
   * @param {Object} res - Objeto de respuesta Express.
   * @param {Function} next - Función para pasar al siguiente middleware.
   */
  async obtenerProyecto(req, res, next) {
    try {
      // Obtener el proyecto usando el servicio
      const proyecto = await this.proyectoService.obtenerProyecto(req.params.id);
      
      // Si no se encuentra el proyecto, lanzar error 404
      if (!proyecto) {
        throw new ApiError('Proyecto no encontrado', 404);
      }
      
      // Responder con el proyecto encontrado
      res.json(proyecto);
    } catch (error) {
      next(error);
    }
  }

  /**
   * Maneja la actualización de un proyecto existente.
   * @async
   * @param {Object} req - Objeto de solicitud Express.
   * @param {Object} res - Objeto de respuesta Express.
   * @param {Function} next - Función para pasar al siguiente middleware.
   */
  async actualizarProyecto(req, res, next) {
    try {
      // Validar los datos de entrada con Zod
      const validatedData = proyectoUpdateSchema.parse(req.body);
      
      // Actualizar el proyecto usando el servicio
      const proyecto = await this.proyectoService.actualizarProyecto(
        req.params.id,
        validatedData
      );
      
      // Responder con el proyecto actualizado
      res.json(proyecto);
    } catch (error) {
      next(error);
    }
  }

  /**
   * Maneja la eliminación de un proyecto existente.
   * @async
   * @param {Object} req - Objeto de solicitud Express.
   * @param {Object} res - Objeto de respuesta Express.
   * @param {Function} next - Función para pasar al siguiente middleware.
   */
  async eliminarProyecto(req, res, next) {
    try {
      // Eliminar el proyecto usando el servicio
      await this.proyectoService.eliminarProyecto(req.params.id);
      
      // Responder sin contenido (204)
      res.status(204).end();
    } catch (error) {
      next(error);
    }
  }

  /**
   * Maneja el listado de proyectos, con filtrado opcional por estado.
   * @async
   * @param {Object} req - Objeto de solicitud Express.
   * @param {Object} res - Objeto de respuesta Express.
   * @param {Function} next - Función para pasar al siguiente middleware.
   */
  async listarProyectos(req, res, next) {
    try {
      // Obtener el parámetro de estado si existe
      const { estado } = req.query;
      
      // Listar proyectos usando el servicio
      const proyectos = await this.proyectoService.listarProyectos(estado);
      
      // Responder con la lista de proyectos
      res.json(proyectos);
    } catch (error) {
      next(error);
    }
  }
}

export default ProyectoController;